



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Cirrus CI is a modern Continuous Integration system built for the era of cloud computing. Cirrus CI supports both Linux and Windows environments as well as various cloud computing services like Kubernetes and Google Cloud Platform.
">
      
      
        <link rel="canonical" href="https://cirrus-ci.org/guide/writing-tasks/">
      
      
        <meta name="author" content="Cirrus Labs">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.5.0">
    
    
      
        <title>Writing Tasks - Cirrus CI</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.1b62728e.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#3f51b5">
      
    
    
      <script src="../../assets/javascripts/modernizr.268332fc.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-110620457-1", "cirrus-ci.org")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#execution-environment" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://cirrus-ci.org" title="Cirrus CI" class="md-header-nav__button md-logo">
          
            <img src="../../assets/images/logo.svg" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Cirrus CI
            </span>
            <span class="md-header-nav__topic">
              
                Writing Tasks
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/cirruslabs/cirrus-ci-docs/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../.." class="md-tabs__link">
          Home
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../features/" class="md-tabs__link">
          Features
        </a>
      
    </li>
  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../quick-start/" class="md-tabs__link md-tabs__link--active">
          Documentation
        </a>
      
    </li>
  

  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../examples/" class="md-tabs__link">
          Examples
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../pricing/" class="md-tabs__link">
          Pricing
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../support/" class="md-tabs__link">
          Support
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://cirrus-ci.org" title="Cirrus CI" class="md-nav__button md-logo">
      
        <img src="../../assets/images/logo.svg" width="48" height="48">
      
    </a>
    Cirrus CI
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/cirruslabs/cirrus-ci-docs/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    
      <a href="/" title="Home" class="md-nav__link">
        Home
      </a>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    
      <a href="/features" title="Features" class="md-nav__link">
        Features
      </a>
    
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Documentation
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Documentation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-1" type="checkbox" id="nav-3-1" checked>
    
    <label class="md-nav__link" for="nav-3-1">
      User Guide
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-1">
        User Guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    
      <a href="/guide/quick-start/" title="Quick Start" class="md-nav__link">
        Quick Start
      </a>
    
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Writing Tasks
      </label>
    
    <a href="/guide/writing-tasks/" title="Writing Tasks" class="md-nav__link md-nav__link--active">
      Writing Tasks
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#execution-environment" class="md-nav__link">
    Execution Environment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supported-instructions" class="md-nav__link">
    Supported Instructions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#script-instruction" class="md-nav__link">
    Script Instruction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#background-script-instruction" class="md-nav__link">
    Background Script Instruction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cache-instruction" class="md-nav__link">
    Cache Instruction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#artifacts-instruction" class="md-nav__link">
    Artifacts Instruction
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#artifact-type" class="md-nav__link">
    Artifact Type
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#artifact-parsing" class="md-nav__link">
    Artifact Parsing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#file-instruction" class="md-nav__link">
    File Instruction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution-behavior-of-instructions" class="md-nav__link">
    Execution Behavior of Instructions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#environment-variables" class="md-nav__link">
    Environment Variables
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#behavioral-environment-variables" class="md-nav__link">
    Behavioral Environment Variables
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#encrypted-variables" class="md-nav__link">
    Encrypted Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matrix-modification" class="md-nav__link">
    Matrix Modification
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-execution-dependencies" class="md-nav__link">
    Task Execution Dependencies
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conditional-task-execution" class="md-nav__link">
    Conditional Task Execution
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#supported-operators" class="md-nav__link">
    Supported Operators
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#supported-functions" class="md-nav__link">
    Supported Functions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#auto-cancellation-of-tasks" class="md-nav__link">
    Auto-Cancellation of Tasks
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#failure-toleration" class="md-nav__link">
    Failure Toleration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#manual-tasks" class="md-nav__link">
    Manual tasks
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-execution-lock" class="md-nav__link">
    Task Execution Lock
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#required-pr-labels" class="md-nav__link">
    Required PR Labels
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#http-cache" class="md-nav__link">
    HTTP Cache
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#additional-containers" class="md-nav__link">
    Additional Containers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#embedded-badges" class="md-nav__link">
    Embedded Badges
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#badges-in-markdown" class="md-nav__link">
    Badges in Markdown
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    
      <a href="/guide/tips-and-tricks/" title="Configuration Tips and Tricks" class="md-nav__link">
        Configuration Tips and Tricks
      </a>
    
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-1-4" type="checkbox" id="nav-3-1-4">
    
    <label class="md-nav__link" for="nav-3-1-4">
      Execution Environment
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-3-1-4">
        Execution Environment
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    
      <a href="/guide/linux/" title="Linux Containers" class="md-nav__link">
        Linux Containers
      </a>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    
      <a href="/guide/windows/" title="Windows Containers" class="md-nav__link">
        Windows Containers
      </a>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    
      <a href="/guide/macOS/" title="macOS VMs" class="md-nav__link">
        macOS VMs
      </a>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    
      <a href="/guide/FreeBSD/" title="FreeBSD VMs" class="md-nav__link">
        FreeBSD VMs
      </a>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    
      <a href="/guide/docker-builder-vm/" title="Docker Builder on VM" class="md-nav__link">
        Docker Builder on VM
      </a>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    
      <a href="/guide/docker-builds-on-kubernetes/" title="Docker Builds on GKE" class="md-nav__link">
        Docker Builds on GKE
      </a>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    
      <a href="/guide/docker-pipe/" title="Docker Pipe" class="md-nav__link">
        Docker Pipe
      </a>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    
      <a href="/guide/supported-computing-services/" title="Computing Services" class="md-nav__link">
        Computing Services
      </a>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    
      <a href="/guide/build-life/" title="Life of a Build" class="md-nav__link">
        Life of a Build
      </a>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    
      <a href="/guide/notifications/" title="Notifications" class="md-nav__link">
        Notifications
      </a>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    
      <a href="/api/" title="API" class="md-nav__link">
        API
      </a>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    
      <a href="/faq/" title="FAQ" class="md-nav__link">
        FAQ
      </a>
    
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-4" type="checkbox" id="nav-3-4">
    
    <label class="md-nav__link" for="nav-3-4">
      Legal
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-4">
        Legal
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    
      <a href="/legal/privacy/" title="Privacy" class="md-nav__link">
        Privacy
      </a>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    
      <a href="/legal/terms/" title="Terms of Service" class="md-nav__link">
        Terms of Service
      </a>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    
      <a href="/security/" title="Security" class="md-nav__link">
        Security
      </a>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    
      <a href="/examples" title="Examples" class="md-nav__link">
        Examples
      </a>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    
      <a href="/pricing" title="Pricing" class="md-nav__link">
        Pricing
      </a>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    
      <a href="/support" title="Support" class="md-nav__link">
        Support
      </a>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#execution-environment" class="md-nav__link">
    Execution Environment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supported-instructions" class="md-nav__link">
    Supported Instructions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#script-instruction" class="md-nav__link">
    Script Instruction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#background-script-instruction" class="md-nav__link">
    Background Script Instruction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cache-instruction" class="md-nav__link">
    Cache Instruction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#artifacts-instruction" class="md-nav__link">
    Artifacts Instruction
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#artifact-type" class="md-nav__link">
    Artifact Type
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#artifact-parsing" class="md-nav__link">
    Artifact Parsing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#file-instruction" class="md-nav__link">
    File Instruction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution-behavior-of-instructions" class="md-nav__link">
    Execution Behavior of Instructions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#environment-variables" class="md-nav__link">
    Environment Variables
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#behavioral-environment-variables" class="md-nav__link">
    Behavioral Environment Variables
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#encrypted-variables" class="md-nav__link">
    Encrypted Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matrix-modification" class="md-nav__link">
    Matrix Modification
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-execution-dependencies" class="md-nav__link">
    Task Execution Dependencies
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conditional-task-execution" class="md-nav__link">
    Conditional Task Execution
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#supported-operators" class="md-nav__link">
    Supported Operators
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#supported-functions" class="md-nav__link">
    Supported Functions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#auto-cancellation-of-tasks" class="md-nav__link">
    Auto-Cancellation of Tasks
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#failure-toleration" class="md-nav__link">
    Failure Toleration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#manual-tasks" class="md-nav__link">
    Manual tasks
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-execution-lock" class="md-nav__link">
    Task Execution Lock
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#required-pr-labels" class="md-nav__link">
    Required PR Labels
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#http-cache" class="md-nav__link">
    HTTP Cache
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#additional-containers" class="md-nav__link">
    Additional Containers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#embedded-badges" class="md-nav__link">
    Embedded Badges
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#badges-in-markdown" class="md-nav__link">
    Badges in Markdown
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/cirruslabs/cirrus-ci-docs/blob/master/docs/guide/writing-tasks.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>Writing Tasks</h1>
                
                <p>A <code>task</code> simply defines a sequence of <a href="#supported-instructions">instructions</a> to execute and an <a href="#execution-environment">execution environment</a>
to execute these instructions in. Let's see a line-by-line example of a <code>.cirrus.yml</code> configuration file first:</p>
<div class="codehilite"><pre><span></span><span class="nt">test_task</span><span class="p">:</span>
  <span class="nt">container</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gradle:jdk11</span>
  <span class="nt">test_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gradle test</span>
</pre></div>

<p>The example above defines a single task that will be scheduled and executed on the <a href="../linux/">Linux Community Cluster</a> using the <code>gradle:jdk11</code> Docker image.
Only one user-defined <a href="#script-instruction">script instruction</a> to run <code>gradle test</code> will be executed. Pretty simple, isn't it?</p>
<p>Please read the topics below if you want better understand what's doing on in a more complex <code>.cirrus.yml</code> configuration file, such as this:</p>
<div class="codehilite"><pre><span></span><span class="c1"># global default</span>
<span class="nt">container</span><span class="p">:</span>
  <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">node:latest</span>

<span class="nt">task</span><span class="p">:</span>
  <span class="nt">node_modules_cache</span><span class="p">:</span>
    <span class="nt">folder</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">node_modules</span>
    <span class="nt">fingerprint_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cat yarn.lock</span>
    <span class="nt">populate_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yarn install</span>

  <span class="nt">matrix</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Lint</span>
      <span class="nt">lint_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yarn run lint</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Test</span>
      <span class="nt">container</span><span class="p">:</span>
        <span class="nt">matrix</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">node:latest</span>
          <span class="p p-Indicator">-</span> <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">node:lts</span>
      <span class="nt">test_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yarn run test</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Publish</span>
      <span class="nt">depends_on</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Lint</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Test</span>
      <span class="nt">only_if</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$BRANCH == &quot;master&quot;</span>
      <span class="nt">publish_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yarn run publish</span>
</pre></div>

<div class="admonition tip">
<p class="admonition-title">Task Naming</p>
<p>To name a task one can simply use the <code>name</code> field. <code>foo_task</code> syntax is simply a syntactic sugar. Separate name
field is very useful when you want to have a rich task name:</p>
<div class="codehilite"><pre><span></span><span class="nt">task</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Tests (macOS)</span>
  <span class="l l-Scalar l-Scalar-Plain">...</span>
</pre></div>

<p><strong>Note:</strong> instructions within a task can only be named via a prefix (e.g. <code>test_script</code>).</p>
</div>
<h2 id="execution-environment">Execution Environment<a class="headerlink" href="#execution-environment" title="Permanent link">&para;</a></h2>
<p>In order to specify where to execute a particular task you can choose from a variety of options by defining one of the
following fields for a <code>task</code>:</p>
<table>
<thead>
<tr>
<th>Field Name</th>
<th>Computing Service</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>container</code></td>
<td><a href="../linux/">Linux Community Cluster</a></td>
<td>Linux Docker Container</td>
</tr>
<tr>
<td><code>windows_container</code></td>
<td><a href="../windows/">Windows Community Cluster</a></td>
<td>Windows Docker Container</td>
</tr>
<tr>
<td><code>osx_instance</code></td>
<td><a href="../macOS/">macOS Community Cluster</a></td>
<td>macOS Virtual Machines</td>
</tr>
<tr>
<td><code>freebsd_instance</code></td>
<td><a href="../FreeBSD/">FreeBSD Community Cluster</a></td>
<td>FreeBSD Virtual Machines</td>
</tr>
<tr>
<td><code>gce_instance</code></td>
<td><a href="../supported-computing-services/#compute-engine">Google Compute Engine</a></td>
<td>Linux, Windows and FreeBSD Virtual Machines in your GCP project</td>
</tr>
<tr>
<td><code>gke_container</code></td>
<td><a href="../supported-computing-services/#kubernetes-engine">Google Kubernetes Engine</a></td>
<td>Linux Docker Containers on private GKE cluster</td>
</tr>
<tr>
<td><code>ec2_instance</code></td>
<td><a href="../supported-computing-services/#ec2">Amazon Elastic Compute Cloud</a></td>
<td>Linux Virtual Machines in your AWS</td>
</tr>
<tr>
<td><code>eks_instance</code></td>
<td><a href="../supported-computing-services/#eks">Amazon Elastic Container Service</a></td>
<td>Linux Docker Containers on private EKS cluster</td>
</tr>
<tr>
<td><code>azure_container_instance</code></td>
<td><a href="../supported-computing-services/#azure-container-instances">Azure Container Instances</a></td>
<td>Linux and Windows Docker Container on Azure</td>
</tr>
<tr>
<td><code>anka_instance</code></td>
<td><a href="../supported-computing-services/#anka">Anka Build by Veertu</a></td>
<td>macOS VMs on your Anka Build</td>
</tr>
</tbody>
</table>
<h2 id="supported-instructions">Supported Instructions<a class="headerlink" href="#supported-instructions" title="Permanent link">&para;</a></h2>
<p>Each task is essentially a collection of instructions that are executed sequentially. The following instructions are supported:</p>
<ul>
<li><a href="#script-instruction"><code>script</code></a> instruction to execute a script.</li>
<li><a href="#background-script-instruction"><code>background_script</code></a> instruction to execute a script in a background.</li>
<li><a href="#cache-instruction"><code>cache</code></a> instruction to persist files between task runs.</li>
<li><a href="#artifacts-instruction"><code>artifacts</code></a> instruction to store and expose files created via a task.</li>
<li><a href="#file-instruction"><code>file</code></a> instruction to create a file from an environment variable.</li>
</ul>
<h3 id="script-instruction">Script Instruction<a class="headerlink" href="#script-instruction" title="Permanent link">&para;</a></h3>
<p>A <code>script</code> instruction executes commands via <code>shell</code> on Unix or <code>batch</code> on Windows. A <code>script</code> instruction can be named by
adding a name as a prefix. For example <code>test_script</code> or <code>my_very_specific_build_step_script</code>. Naming script instructions
helps gather more granular information about task execution. Cirrus CI will use it in future to auto-detect performance
regressions.</p>
<p>Script commands can be specified as a single string value or a list of string values in a <code>.cirrus.yml</code> configuration file
like in the example below:</p>
<div class="codehilite"><pre><span></span><span class="nt">check_task</span><span class="p">:</span>
  <span class="nt">compile_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gradle --parallel classes testClasses</span>
  <span class="nt">check_script</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">echo &quot;Here comes more then one script!&quot;</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">printenv</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">gradle check</span>
</pre></div>

<p><strong>Note:</strong> Each script instruction is executed in a newly created process, therefore environment variables are not preserved between them.</p>
<h3 id="background-script-instruction">Background Script Instruction<a class="headerlink" href="#background-script-instruction" title="Permanent link">&para;</a></h3>
<p>A <code>background_script</code> instruction is absolutely the same as <code>script</code> instruction but Cirrus CI won't wait for the script to finish
and will continue execution of further instructions.</p>
<p>Background scripts can be useful when something needs to be executed in the background. For example, a database or
some emulators. Traditionally the same effect is achieved by adding <code>&amp;</code> to a command like <code>$: command &amp;</code>. Problem here
is that logs from <code>command</code> will be mixed into regular logs of the following commands. By using background scripts
not only logs will be properly saved and displayed, but also <code>command</code> itself will be properly killed in the end of a task.</p>
<p>Here is an example of how <code>background_script</code> instruction can be used to run an android emulator:</p>
<div class="codehilite"><pre><span></span><span class="nt">android_test_task</span><span class="p">:</span>
  <span class="nt">start_emulator_background_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">emulator -avd test -no-audio -no-window</span>
  <span class="nt">wait_for_emulator_to_boot_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">adb wait-for-device</span>
  <span class="nt">test_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gradle test</span>
</pre></div>

<h3 id="cache-instruction">Cache Instruction<a class="headerlink" href="#cache-instruction" title="Permanent link">&para;</a></h3>
<p>A <code>cache</code> instruction allows to persist a folder and reuse it during the next execution of the task. A <code>cache</code> instruction can be named the same way as <code>script</code> instruction.</p>
<p>Here is an example:</p>
<div class="codehilite"><pre><span></span><span class="nt">test_task</span><span class="p">:</span>
  <span class="nt">container</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">node:latest</span>
  <span class="nt">node_modules_cache</span><span class="p">:</span>
    <span class="nt">folder</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">node_modules</span>
    <span class="nt">fingerprint_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cat yarn.lock</span>
    <span class="nt">populate_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yarn install</span>
  <span class="nt">test_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yarn run test</span>
</pre></div>

<p>The <code>folder</code> is a <em>required</em> field that tells the agent which folder to cache. It should be relative to the working directory, or the root directory of the machine (ex. <code>node_modules</code> or <code>/usr/bin/bundler</code>).</p>
<p>A <code>fingerprint_script</code> is an <em>optional</em> field that can specify a script that will be executed and console output of which
will be used as a key for the given cache. By default the task name is used as a fingerprint value.</p>
<p>After the last <code>script</code> instruction for the task succeeds, Cirrus CI will calculate checksum of the cached folder (note that it's unrelated to <code>fingerprint_script</code> instruction) and re-upload the cache if it finds any changes.
To avoid a time-costly re-upload, remove volatile files from the cache (for example, in the last <code>script</code> instruction of a task).</p>
<p><code>populate_script</code> is an <em>optional</em> field that can specify a script that will be executed to populate the cache.
<code>populate_script</code> should create the <code>folder</code> if it doesn't exist before the <code>cache</code> instruction.
If your dependencies are updated often, please pay attention to <code>fingerprint_script</code> and make sure it will produce different outputs for different versions of your dependency (ideally just print locked versions of dependencies).</p>
<p>That means the only difference between the example above and below is that <code>yarn install</code> will always be executed in the
example below where in the example above only when <code>yarn.lock</code> has changes.</p>
<div class="codehilite"><pre><span></span><span class="nt">test_task</span><span class="p">:</span>
  <span class="nt">container</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">node:latest</span>
  <span class="nt">node_modules_cache</span><span class="p">:</span>
    <span class="nt">folder</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">node_modules</span>
    <span class="nt">fingerprint_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cat yarn.lock</span>
  <span class="nt">install_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yarn install</span>
  <span class="nt">test_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yarn run test</span>
</pre></div>

<div class="admonition warning">
<p class="admonition-title">Caching for Pull Requests</p>
<p>Tasks for PRs upload caches to a separate caching namespace to not interfere with caches used by other tasks.
But such PR tasks <strong>can read</strong> all caches even from the main caching namespace for a repository.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Scope of cached artifacts</p>
<p>Cache artifacts are shared between tasks, so two caches with the same name on e.g. Linux containers and macOS VMs will share the same set of files.
This may introduce binary incompatibility between caches. To avoid that, add <code>echo $CIRRUS_OS</code> into <code>fingerprint_script</code> which will distinguish caches based on OS.</p>
</div>
<h3 id="artifacts-instruction">Artifacts Instruction<a class="headerlink" href="#artifacts-instruction" title="Permanent link">&para;</a></h3>
<p>An <code>artifacts</code> instruction allows to store files and expose them in the UI for downloading later. An <code>artifacts</code> instruction
can be named the same way as <code>script</code> instruction and has only one required <code>path</code> field which accepts a <a href="https://en.wikipedia.org/wiki/Glob_(programming)">glob pattern</a>
of files relative to <code>$CIRRUS_WORKING_DIR</code> to store. Right now only storing files under <a href="#environment-variables"><code>$CIRRUS_WORKING_DIR</code> folder</a> as artifacts is supported.</p>
<p>In the example below, <em>Build and Test</em> task produces two artifacts: <code>binaries</code> artifacts with all executables built during a
successful task completion and <code>junit</code> artifacts with all test reports regardless of the final task status (more about
that you can learn in the <a href="#execution-behavior-of-instructions">next section describing execution behavior</a>).</p>
<div class="codehilite"><pre><span></span><span class="nt">build_and_test_task</span><span class="p">:</span>
  <span class="c1"># instructions to build and test</span>
  <span class="nt">binaries_artifacts</span><span class="p">:</span>
    <span class="nt">path</span><span class="p">:</span> <span class="s">&quot;build/*&quot;</span>
  <span class="nt">always</span><span class="p">:</span>
    <span class="nt">junit_artifacts</span><span class="p">:</span>
      <span class="nt">path</span><span class="p">:</span> <span class="s">&quot;**/test-results/**/*.xml&quot;</span>
      <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">text/xml</span>
      <span class="nt">format</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">junit</span>
</pre></div>

<div class="admonition tip">
<p class="admonition-title">URL to the latest artifacts</p>
<p>It is possible to refer to the latest artifacts directly (artifacts of the latests <strong>successful</strong> build).
Use the following link format to download the latest artifact of a particular task:</p>
<div class="codehilite"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">https://api.cirrus-ci.com/v1/artifact/github/&lt;USER OR ORGANIZATION&gt;/&lt;REPOSITORY&gt;/&lt;TASK NAME&gt;/&lt;ARTIFACTS NAME&gt;/&lt;PATH&gt;</span>
</pre></div>

<p>It is possible to also <strong>download an archive</strong> of all files within an artifact with the following link:</p>
<div class="codehilite"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">https://api.cirrus-ci.com/v1/artifact/github/&lt;USER OR ORGANIZATION&gt;/&lt;REPOSITORY&gt;/&lt;TASK NAME&gt;/&lt;ARTIFACTS NAME&gt;.zip</span>
</pre></div>

<p>By default, Cirrus looks up the latest <strong>successful</strong> build of the default branch for the repository but the branch name
can be customized via <code>?branch=&lt;BRANCH&gt;</code> query paramter. </p>
</div>
<h4 id="artifact-type">Artifact Type<a class="headerlink" href="#artifact-type" title="Permanent link">&para;</a></h4>
<p>If you want the Cirrus CI API to return a mimetype other then <code>application/octet-stream</code>, for example if you wanted certain files to download in a way you don't need to change the extension for, you can specify the <code>type</code> parameter, for example:</p>
<div class="codehilite"><pre><span></span>  <span class="nt">my_task</span><span class="p">:</span>
    <span class="nt">my_dotjar_artifacts</span><span class="p">:</span>
      <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">build/*.jar</span>
      <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">application/java-archive</span>
</pre></div>

<p>A list of some of the basic types supported can be found <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types/Complete_list_of_MIME_types">here</a>.</p>
<h4 id="artifact-parsing">Artifact Parsing<a class="headerlink" href="#artifact-parsing" title="Permanent link">&para;</a></h4>
<p>Cirrus CI supports parsing artifacts in order to extract information that can be presented in the UI for a <a href="https://medium.com/cirruslabs/github-annotations-support-227d179cde31">better user experience</a>.
Simply use <code>format</code> field of an artifact instruction to specify artifact's format:</p>
<div class="codehilite"><pre><span></span><span class="nt">junit_artifacts</span><span class="p">:</span>
  <span class="nt">path</span><span class="p">:</span> <span class="s">&quot;**/test-results/**/*.xml&quot;</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">text/xml</span>
  <span class="nt">format</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">junit</span>
</pre></div>

<p>Currently Cirrus CI can only parse JUnit XML artifacts but many tools use this format already. Please <a href="https://github.com/cirruslabs/cirrus-ci-annotations/issues/new">let us know</a>
what kind of formats Cirrus CI should support next!</p>
<h3 id="file-instruction">File Instruction<a class="headerlink" href="#file-instruction" title="Permanent link">&para;</a></h3>
<p>A <code>file</code> instruction allows to create a file from an environment variable. It is especially useful for situations when
execution environment doesn't have proper shell to use <code>echo ... &gt;&gt; ...</code> syntax, for example, within <a href="https://docs.docker.com/samples/library/scratch/">scratch Docker containers</a>.</p>
<p>Here is an example of how to populate Docker config from an <a href="#encrypted-variables">encrypted environment variable</a>:</p>
<div class="codehilite"><pre><span></span><span class="nt">task</span><span class="p">:</span>
  <span class="nt">environment</span><span class="p">:</span>
    <span class="nt">DOCKER_CONFIG</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ENCRYPTED[qwerty]</span>
  <span class="nt">docker_config_file</span><span class="p">:</span>
    <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/root/.docker/config</span>
    <span class="nt">variable_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">DOCKER_CONFIG</span>
</pre></div>

<h3 id="execution-behavior-of-instructions">Execution Behavior of Instructions<a class="headerlink" href="#execution-behavior-of-instructions" title="Permanent link">&para;</a></h3>
<p>By default Cirrus CI executes instructions one after another and stops the overall task execution on the first failure.
Sometimes there might be situations when some scripts should always be executed or some debug information needs to be saved
on a failure. For such situations the <code>always</code> and <code>on_failure</code> keywords can be used to group instructions.</p>
<div class="codehilite"><pre><span></span><span class="nt">task</span><span class="p">:</span>
  <span class="nt">test_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./run_tests.sh</span>
  <span class="nt">on_failure</span><span class="p">:</span>
    <span class="nt">debug_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./print_additional_debug_info.sh</span>
  <span class="nt">always</span><span class="p">:</span>
    <span class="nt">test_reports_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./print_test_reports.sh</span>
</pre></div>

<p>In the example above, <code>print_additional_debug_info.sh</code> script will be executed only on failures to output some additional
debug information. <code>print_test_reports.sh</code> on the other hand will be executed both on successful and and failed runs to
print test reports (test reports are always useful! <img alt="😄" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/1f604.svg" title=":smile:" />).</p>
<h2 id="environment-variables">Environment Variables<a class="headerlink" href="#environment-variables" title="Permanent link">&para;</a></h2>
<p>Environment variables can be configured under the <code>env</code> or <code>environment</code> keywords in <code>.cirrus.yml</code> files. Here is an example:</p>
<div class="codehilite"><pre><span></span><span class="nt">echo_task</span><span class="p">:</span>
  <span class="nt">env</span><span class="p">:</span>
    <span class="nt">FOO</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Bar</span>
  <span class="nt">echo_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">echo $FOO</span>
</pre></div>

<p>You can reference other environment variables using <code>$VAR</code>, <code>${VAR}</code> or <code>%VAR%</code> syntax:</p>
<div class="codehilite"><pre><span></span><span class="nt">custom_path_task</span><span class="p">:</span>
  <span class="nt">env</span><span class="p">:</span>
    <span class="nt">SDK_ROOT</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${HOME}/sdk</span>
    <span class="nt">PATH</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${SDK_ROOT}/bin:${PATH}</span>
  <span class="nt">custom_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sdktool install</span>
</pre></div>

<p>Environment variables may also be set at the root level of <code>.cirrus.yml</code>. In that case, they will be merged with each task's
individual environment variables, but the task level variables always take precedence. For example:</p>
<div class="codehilite"><pre><span></span><span class="nt">env</span><span class="p">:</span>
  <span class="nt">PATH</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/sdk/bin:${PATH}</span>

<span class="nt">echo_task</span><span class="p">:</span>
  <span class="nt">env</span><span class="p">:</span>
    <span class="nt">PATH</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/opt/bin:${PATH}</span>
  <span class="nt">echo_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">echo $PATH</span>
</pre></div>

<p>Will output <code>/opt/bin:/usr/local/bin:/usr/bin</code> or similar, but will not include <code>/sdk/bin</code> because this root level setting is
ignored.</p>
<p>Also some default environment variables are pre-defined:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Value / Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>CI</td>
<td>true</td>
</tr>
<tr>
<td>CIRRUS_CI</td>
<td>true</td>
</tr>
<tr>
<td>CI_NODE_INDEX</td>
<td>Index of the current task within <code>CI_NODE_TOTAL</code> tasks</td>
</tr>
<tr>
<td>CI_NODE_TOTAL</td>
<td>Total amount of unique tasks for a given <code>CIRRUS_BUILD_ID</code> build</td>
</tr>
<tr>
<td>CONTINUOUS_INTEGRATION</td>
<td><code>true</code></td>
</tr>
<tr>
<td>CIRRUS_API_CREATED</td>
<td><code>true</code> if the current build was created through the <a href="../../api/">API</a>.</td>
</tr>
<tr>
<td>CIRRUS_BASE_BRANCH</td>
<td>Base branch name if current build was triggered by a PR. For example <code>master</code></td>
</tr>
<tr>
<td>CIRRUS_BASE_SHA</td>
<td>Base SHA if current build was triggered by a PR</td>
</tr>
<tr>
<td>CIRRUS_BRANCH</td>
<td>Branch name. For example <code>my-feature</code></td>
</tr>
<tr>
<td>CIRRUS_BUILD_ID</td>
<td>Unique build ID</td>
</tr>
<tr>
<td>CIRRUS_CHANGE_IN_REPO</td>
<td>Git SHA</td>
</tr>
<tr>
<td>CIRRUS_CHANGE_MESSAGE</td>
<td>Commit message or PR title and description, depending on trigger event (Non-PRs or PRs respectively).</td>
</tr>
<tr>
<td>CIRRUS_DEFAULT_BRANCH</td>
<td>Default repository branch name. For example <code>master</code></td>
</tr>
<tr>
<td>CIRRUS_LAST_GREEN_BUILD_ID</td>
<td>The build id of the last successful build on the same branch at the time of the current build creation.</td>
</tr>
<tr>
<td>CIRRUS_LAST_GREEN_CHANGE</td>
<td>Corresponding to <code>CIRRUS_LAST_GREEN_BUILD_ID</code> SHA (used in <a href="#supported-functions"><code>changesInclude</code> function</a>).</td>
</tr>
<tr>
<td>CIRRUS_PR</td>
<td>PR number if current build was triggered by a PR. For example <code>239</code>.</td>
</tr>
<tr>
<td>CIRRUS_TAG</td>
<td>Tag name if current build was triggered by a new tag. For example <code>v1.0</code></td>
</tr>
<tr>
<td>CIRRUS_OS, OS</td>
<td>Host OS. Either <code>linux</code>, <code>windows</code> or <code>darwin</code>.</td>
</tr>
<tr>
<td>CIRRUS_TASK_NAME</td>
<td>Task name</td>
</tr>
<tr>
<td>CIRRUS_TASK_ID</td>
<td>Unique task ID</td>
</tr>
<tr>
<td>CIRRUS_RELEASE</td>
<td>GitHub Release id if current tag was created for a release. Handy for <a href="../../examples/#release-assets">uploading release assets</a>.</td>
</tr>
<tr>
<td>CIRRUS_REPO_CLONE_TOKEN</td>
<td>Temporary GitHub access token to perform a clone.</td>
</tr>
<tr>
<td>CIRRUS_REPO_NAME</td>
<td>Repository name. For example <code>my-project</code></td>
</tr>
<tr>
<td>CIRRUS_REPO_OWNER</td>
<td>Repository owner (an organization or a user). For example <code>my-organization</code></td>
</tr>
<tr>
<td>CIRRUS_REPO_FULL_NAME</td>
<td>Repository full name/slug. For example <code>my-organization/my-project</code></td>
</tr>
<tr>
<td>CIRRUS_REPO_CLONE_URL</td>
<td>URL used for cloning. For example <code>https://github.com/my-organization/my-project.git</code></td>
</tr>
<tr>
<td>CIRRUS_USER_COLLABORATOR</td>
<td><code>true</code> if a user initialized a build is already a contributor to the repository. <code>false</code> otherwise.</td>
</tr>
<tr>
<td>CIRRUS_USER_PERMISSION</td>
<td><code>admin</code>, <code>write</code>, <code>read</code> or <code>none</code>.</td>
</tr>
<tr>
<td>CIRRUS_HTTP_CACHE_HOST</td>
<td>Host and port number on which <a href="#http-cache">local HTTP cache</a> can be accessed on.</td>
</tr>
<tr>
<td>GITHUB_CHECK_SUITE_ID</td>
<td>Monotonically increasing id of a corresponding <a href="https://help.github.com/en/articles/about-status-checks#checks">GitHub Check Suite</a> which caused the Cirrus CI build.</td>
</tr>
</tbody>
</table>
<h3 id="behavioral-environment-variables">Behavioral Environment Variables<a class="headerlink" href="#behavioral-environment-variables" title="Permanent link">&para;</a></h3>
<p>And some environment variables can be set to control behavior of the Cirrus CI Agent:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Default Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>CIRRUS_CLONE_DEPTH</td>
<td><code>0</code> which will reflect in a full clone of a single branch</td>
<td>Clone depth.</td>
</tr>
<tr>
<td>CIRRUS_SHELL</td>
<td><code>sh</code> on Linux/macOS/FreeBSD and <code>cmd.exe</code> on Windows. Set to <code>direct</code> to execute each script directly without wrapping the commands in a shell script.</td>
<td>Shell that Cirrus CI uses to execute scripts. By default <code>sh</code> is used.</td>
</tr>
<tr>
<td>CIRRUS_WORKING_DIR</td>
<td><code>cirrus-ci-build</code> folder inside of a system's temporary folder</td>
<td>Working directory where Cirrus CI executes builds. Default to <code>cirrus-ci-build</code> folder inside of a system's temporary folder.</td>
</tr>
</tbody>
</table>
<h2 id="encrypted-variables">Encrypted Variables<a class="headerlink" href="#encrypted-variables" title="Permanent link">&para;</a></h2>
<p>It is possible to add encrypted variables to a <code>.cirrus.yml</code> file. These variables are decrypted only in builds for commits and pull requests that are made by users with <code>write</code> permission or approved by them.</p>
<p>In order to encrypt a variable go to repository's settings page via clicking settings icon <img alt="settings icon" src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_settings_black_24px.svg" />
on a repository's main page (for example <code>https://cirrus-ci.com/github/my-organization/my-repository</code>) and follow instructions.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Only users with <code>WRITE</code> permissions can add encrypted variables to a repository.</p>
</div>
<p>An encrypted variable will be presented in a form like <code>ENCRYPTED[qwerty239abc]</code> which can be safely committed to <code>.cirrus.yml</code> file:</p>
<div class="codehilite"><pre><span></span><span class="nt">publish_task</span><span class="p">:</span>
  <span class="nt">environment</span><span class="p">:</span>
    <span class="nt">AUTH_TOKEN</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ENCRYPTED[qwerty239abc]</span>
  <span class="nt">script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./publish.sh</span>
</pre></div>

<p>Cirrus CI encrypts variables with a unique per repository 256-bit encryption key so forks and even repositories within
the same organization cannot re-use them. <code>qwerty239abc</code> from the example above is <strong>NOT</strong> the content of your encrypted
variable, it's just an internal ID. No one can brute force your secrets from such ID. In addition, Cirrus CI doesn't know
a relation between an encrypted variable and a repository for which the encrypted variable was created.</p>
<details class="tip"><summary>Organization Level Encrypted Variables</summary><p>Sometimes there might be secrets that are used in almost all repositories of an organization. For example, credentials
to a <a href="../supported-computing-services/">compute service</a> where tasks will be executed. In order to create such sharable
encrypted variable go to organization's settings page via clicking settings icon <img alt="settings icon" src="https://storage.googleapis.com/material-icons/external-assets/v4/icons/svg/ic_settings_black_24px.svg" />
on an organization's main page (for example <code>https://cirrus-ci.com/github/my-organization</code>) and follow instructions
in <em>Organization Level Encrypted Variables</em> section.</p>
</details>
<details class="warning"><summary>Encrypted Variable for Cloud Credentials</summary><p>In case you use integration with <a href="../supported-computing-services/">one of supported computing services</a>, an encrypted variable
used to store credentials that Cirrus is using to communicate with the computing service won't be decrypted if used
in <a href="#encrypted-variables">environment variables</a>. These credentials have too many permissions for most of the cases,
please create separate credentials with the minimum needed permissions for your specific case.</p>
<div class="codehilite"><pre><span></span><span class="nt">gcp_credentials</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">SECURED[!qwerty]</span>

<span class="nt">env</span><span class="p">:</span>
  <span class="nt">CREDENTIALS</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">SECURED[!qwerty]</span> <span class="c1"># won&#39;t be decrypted in any case</span>
</pre></div>

</details>
<details class="tip"><summary>Skipping Task in Forked Repository</summary><p>In forked repository the decryption of variable fails, which causes failure of task depending on it.
To avoid this by default, make the sensitive task conditional:</p>
<div class="codehilite"><pre><span></span><span class="nt">task</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Task requiring decrypted variables</span>
  <span class="nt">only_if</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$CIRRUS_REPO_OWNER == &#39;my-organization&#39;</span>
  <span class="l l-Scalar l-Scalar-Plain">...</span>
</pre></div>

<p>Owner of forked repository can re-enable the task, if they have the required sensitive data, by encrypting
the variable by themselves and editing both the encrypted variable and repo-owner condition
in the <code>.cirrus.yml</code> file.</p>
</details>
<h2 id="matrix-modification">Matrix Modification<a class="headerlink" href="#matrix-modification" title="Permanent link">&para;</a></h2>
<p>Sometimes it's useful to run the same task against different software versions. Or run different batches of tests based
on an environment variable. For cases like these, the <code>matrix</code> modifier comes very handy. It's possible to use <code>matrix</code>
keyword <strong>only inside of a particular task</strong> to have multiple tasks based on the original one. Each new task will be created
from the original task by replacing the whole <code>matrix</code> YAML node with each <code>matrix</code>'s children separately.</p>
<p>Let check an example of a <code>.cirrus.yml</code>:</p>
<div class="codehilite"><pre><span></span><span class="nt">test_task</span><span class="p">:</span>
  <span class="nt">container</span><span class="p">:</span>
    <span class="nt">matrix</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">node:latest</span>
      <span class="p p-Indicator">-</span> <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">node:lts</span>
  <span class="nt">test_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yarn run test</span>
</pre></div>

<p>Which will be expanded into:</p>
<div class="codehilite"><pre><span></span><span class="nt">test_task</span><span class="p">:</span>
  <span class="nt">container</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">node:latest</span>
  <span class="nt">test_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yarn run test</span>

<span class="nt">test_task</span><span class="p">:</span>
  <span class="nt">container</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">node:lts</span>
  <span class="nt">test_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yarn run test</span>
</pre></div>

<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The <code>matrix</code> modifier can be used multiple times within a task.</p>
</div>
<p>The <code>matrix</code> modification makes it easy to create some pretty complex testing scenarios like this:</p>
<div class="codehilite"><pre><span></span><span class="nt">test_task</span><span class="p">:</span>
  <span class="nt">container</span><span class="p">:</span>
    <span class="nt">matrix</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">node:latest</span>
      <span class="p p-Indicator">-</span> <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">node:lts</span>
  <span class="nt">env</span><span class="p">:</span>
    <span class="nt">matrix</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">COMMAND</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">test</span>
      <span class="p p-Indicator">-</span> <span class="nt">COMMAND</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">lint</span>
  <span class="nt">node_modules_cache</span><span class="p">:</span>
    <span class="nt">folder</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">node_modules</span>
    <span class="nt">fingerprint_script</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">node --version</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">cat yarn.lock</span>
    <span class="nt">populate_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yarn install</span>
  <span class="nt">test_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yarn run $COMMAND</span>
</pre></div>

<h2 id="task-execution-dependencies">Task Execution Dependencies<a class="headerlink" href="#task-execution-dependencies" title="Permanent link">&para;</a></h2>
<p>Sometimes it might be very handy to execute some tasks only after successful execution of other tasks. For such cases
it is possible to specify task names that a particular task depends. Use <code>depends_on</code> keyword to define dependencies:</p>
<div class="codehilite"><pre><span></span><span class="nt">lint_task</span><span class="p">:</span>
  <span class="nt">script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yarn run lint</span>

<span class="nt">test_task</span><span class="p">:</span>
  <span class="nt">script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yarn run test</span>

<span class="nt">publish_task</span><span class="p">:</span>
  <span class="nt">depends_on</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">test</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">lint</span>
  <span class="nt">script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yarn run publish</span>
</pre></div>

<details class="tip"><summary>Task Names and Aliases</summary><p>It is possible to specify the task's name via the <code>name</code> field. <code>lint_task</code> syntax is simply a syntactic sugar that will be
expanded into:</p>
<div class="codehilite"><pre><span></span><span class="nt">task</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">lint</span>
  <span class="l l-Scalar l-Scalar-Plain">...</span>
</pre></div>

<p>Names can be also pretty complex:</p>
<div class="codehilite"><pre><span></span><span class="nt">task</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Test Shard $TESTS_SPLIT</span>
  <span class="nt">env</span><span class="p">:</span>
    <span class="nt">matrix</span><span class="p">:</span>
      <span class="nt">TESTS_SPLIT</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1/3</span>
      <span class="nt">TESTS_SPLIT</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2/2</span>
      <span class="nt">TESTS_SPLIT</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3/3</span>
  <span class="nt">tests_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./.ci/tests.sh</span>

<span class="nt">deploy_task</span><span class="p">:</span>
  <span class="nt">only_if</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$CIRRUS_BRANCH == &#39;master&#39;</span>
  <span class="nt">depends_on</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Test Shard 1/3</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Test Shard 2/3</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Test Shard 3/3</span>
  <span class="nt">script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./.ci/deploy.sh</span>
  <span class="l l-Scalar l-Scalar-Plain">...</span>
</pre></div>

<p>Complex task names make it difficult to list and <strong>maintain</strong> all of such task names in your <code>depends_on</code> field. In order to 
make it simpler you can use the <code>alias</code> field to have a short simplified name for several tasks to use in <code>depends_on</code>.</p>
<p>Here is a modified version of an example above that leverages the <code>alias</code> field:</p>
<div class="codehilite"><pre><span></span><span class="nt">task</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Test Shard $TESTS_SPLIT</span>
<span class="hll">  <span class="nt">alias</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Tests</span>
</span>  <span class="nt">env</span><span class="p">:</span>
    <span class="nt">matrix</span><span class="p">:</span>
      <span class="nt">TESTS_SPLIT</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1/3</span>
      <span class="nt">TESTS_SPLIT</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2/2</span>
      <span class="nt">TESTS_SPLIT</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3/3</span>
  <span class="nt">tests_script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./.ci/tests.sh</span>

<span class="nt">deploy_task</span><span class="p">:</span>
  <span class="nt">only_if</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$CIRRUS_BRANCH == &#39;master&#39;</span>
<span class="hll">  <span class="nt">depends_on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Tests</span>
</span>  <span class="nt">script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./.ci/deploy.sh</span>
</pre></div>

</details>
<h2 id="conditional-task-execution">Conditional Task Execution<a class="headerlink" href="#conditional-task-execution" title="Permanent link">&para;</a></h2>
<p>Some tasks are meant to be created only if a certain condition is met. And some tasks can be skipped in some cases.
Cirrus CI supports the <code>only_if</code> and <code>skip</code> keywords in order to provide such flexibility:</p>
<!-- markdownlint-disable MD031 -->

<!-- markdownlint-disable MD032 -->

<ul>
<li>
<p>The <code>only_if</code> keyword controls whether or not a task will be created. For example, you may want to publish only changes
  committed to the <code>master</code> branch.
  <div class="codehilite"><pre><span></span><span class="nt">publish_task</span><span class="p">:</span>
  <span class="nt">only_if</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$CIRRUS_BRANCH == &#39;master&#39;</span>
  <span class="nt">script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yarn run publish</span>
</pre></div></p>
</li>
<li>
<p>The <code>skip</code> keyword allows to skip execution of a task and mark it as successful. For example, you may want to skip linting
  if no source files have changed since the last successful run.
  <div class="codehilite"><pre><span></span><span class="nt">lint_task</span><span class="p">:</span>
  <span class="nt">skip</span><span class="p">:</span> <span class="s">&quot;!changesInclude(&#39;.cirrus.yml&#39;,</span><span class="nv"> </span><span class="s">&#39;*.js&#39;,</span><span class="nv"> </span><span class="s">&#39;**/*.js&#39;)&quot;</span>
  <span class="nt">script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yarn run lint</span>
</pre></div>
<!-- markdownlint-enable MD032 -->
<!-- markdownlint-enable MD031 --></p>
</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Skip CI Completely</p>
<p>Simply include <code>[skip ci]</code> or <code>[ci skip]</code> in the first line of your commit message in order to skip CI execution for a commit completely.</p>
<p>If you push multiple commits at the same time, only the first line of the last commit message will be checked for <code>[skip ci]</code>
or <code>[ci skip]</code>.</p>
<p>If you open a PR, PR title will be checked for <code>[skip ci]</code> or <code>[ci skip]</code> instead of the last commit message on the PR branch.</p>
</div>
<h3 id="supported-operators">Supported Operators<a class="headerlink" href="#supported-operators" title="Permanent link">&para;</a></h3>
<p>Currently only basic operators like <code>==</code>, <code>!=</code>, <code>=~</code>, <code>!=~</code>, <code>&amp;&amp;</code>, <code>||</code> and unary <code>!</code> are supported in <code>only_if</code> and <code>skip</code> expressions.
<a href="#environment-variables">Environment variables</a> can also be used as usually.</p>
<div class="admonition tip">
<p class="admonition-title">Pattern Matching Example</p>
<p>Use <code>=~</code> operator for pattern matching.</p>
<div class="codehilite"><pre><span></span><span class="nt">check_aggreement_task</span><span class="p">:</span>
  <span class="nt">only_if</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$CIRRUS_BRANCH =~ &#39;pull/.*&#39;</span>
</pre></div>

</div>
<h3 id="supported-functions">Supported Functions<a class="headerlink" href="#supported-functions" title="Permanent link">&para;</a></h3>
<p>Currently only one function is supported in the <code>only_if</code> and <code>skip</code> expressions. <code>changesInclude</code> function allows to check
which files were changed. <code>changesInclude</code> behaves differently for PR builds and regular builds:</p>
<ul>
<li>For PR builds, <code>changesInclude</code> will check the list of files affected by the PR.</li>
<li>For regular builds, <code>changesInclude</code> will use the <code>CIRRUS_LAST_GREEN_CHANGE</code> <a href="#environment-variables">environment variable</a>
  to determine list of affected files between <code>CIRRUS_LAST_GREEN_CHANGE</code> and <code>CIRRUS_CHANGE_IN_REPO</code>.</li>
</ul>
<p><code>changesInclude</code> function can be very useful for skipping some tasks when no changes to sources have been made since the
last successful Cirrus CI build.</p>
<div class="codehilite"><pre><span></span><span class="nt">lint_task</span><span class="p">:</span>
  <span class="nt">skip</span><span class="p">:</span> <span class="s">&quot;!changesInclude(&#39;.cirrus.yml&#39;,</span><span class="nv"> </span><span class="s">&#39;*.js&#39;,</span><span class="nv"> </span><span class="s">&#39;**/*.js&#39;)&quot;</span>
  <span class="nt">script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yarn run lint</span>
</pre></div>

<h2 id="auto-cancellation-of-tasks">Auto-Cancellation of Tasks<a class="headerlink" href="#auto-cancellation-of-tasks" title="Permanent link">&para;</a></h2>
<p>Cirrus CI can automatically cancel tasks in case of new pushes to the same branch. By default Cirrus CI auto-cancels
all tasks for non default branch (for most repositories <code>master</code> branch) but this behavior can be changed by specifying
<code>auto_cancellation</code> field:</p>
<div class="codehilite"><pre><span></span><span class="nt">task</span><span class="p">:</span>
  <span class="nt">auto_cancellation</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$CIRRUS_BRANCH != &#39;master&#39; &amp;&amp; $CIRRUS_BRANCH !=~ &#39;release/.*&#39;</span>
  <span class="l l-Scalar l-Scalar-Plain">...</span>
</pre></div>

<h2 id="failure-toleration">Failure Toleration<a class="headerlink" href="#failure-toleration" title="Permanent link">&para;</a></h2>
<p>Sometimes tasks can play a role of sanity checks. For example, a task can check that your library is working with the latest nightly
version of some dependency package. It will be great to be notified about such failures but it's not necessary to fail the
whole build when a failure occurs. Cirrus CI has the <code>allow_failures</code> keyword which will make a task to not affect the overall status of a build.</p>
<div class="codehilite"><pre><span></span><span class="nt">test_nightly_task</span><span class="p">:</span>
  <span class="nt">allow_failures</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$SOME_PACKAGE_DEPENDENCY_VERSION == &#39;nightly&#39;</span>
</pre></div>

<div class="admonition tip">
<p class="admonition-title">Skipping Notifications</p>
<p>You can also skip posting <strong>red statuses</strong> to GitHub via <code>skip_notifications</code> field.</p>
<div class="codehilite"><pre><span></span><span class="nt">skip_notifications</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$SOME_PACKAGE_DEPENDENCY_VERSION == &#39;nightly&#39;</span>
</pre></div>

<p>It can help to track potential issues overtime without distracting the main workflow.</p>
</div>
<h2 id="manual-tasks">Manual tasks<a class="headerlink" href="#manual-tasks" title="Permanent link">&para;</a></h2>
<p>By default a Cirrus CI task is automatically triggered when all it's <a href="#task-execution-dependencies">dependency tasks</a>
finished successfully. Sometimes though, it can be very handy to trigger some tasks manually, for example, perform a
deployment to staging for manual testing upon all automation checks have succeeded. In order change the default behavior
please use <code>trigger_type</code> field like this:</p>
<div class="codehilite"><pre><span></span><span class="nt">task</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="s">&quot;Staging</span><span class="nv"> </span><span class="s">Deploy&quot;</span>
  <span class="nt">trigger_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">manual</span>
  <span class="nt">depends_on</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Tests (Unit)</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Tests (Ingegration)</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Lint</span>
</pre></div>

<p>You'll be able to manually trigger such paused tasks via Cirrus CI Web UI or directly from GitHub Checks page.</p>
<h2 id="task-execution-lock">Task Execution Lock<a class="headerlink" href="#task-execution-lock" title="Permanent link">&para;</a></h2>
<p>Some CI tasks perform external operations which are required to be executed one at a time. For example, parallel deploys
to the same environment is usually a bad idea. In order to restrict parallel execution of a certain task within a repository,
you can use <code>execution_lock</code> to specify a task's lock key, a unique string that will be used to make sure that any tasks with the same <code>execution_lock</code> string
are executed one at a time. Here is an example of how to make sure deployments 
on a specific branch <em>can not</em> run in parallel:</p>
<div class="codehilite"><pre><span></span><span class="nt">task</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="s">&quot;Automatic</span><span class="nv"> </span><span class="s">Staging</span><span class="nv"> </span><span class="s">Deploy&quot;</span>
  <span class="nt">execution_lock</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$CIRRUS_BRANCH</span>
</pre></div>

<p>You'll be able to manually trigger such paused tasks via the <a href="https://cirrus-ci.com">Cirrus CI Web Dashboard</a> or directly from the commit's <code>checks</code> page on GitHub.</p>
<h2 id="required-pr-labels">Required PR Labels<a class="headerlink" href="#required-pr-labels" title="Permanent link">&para;</a></h2>
<p>Similar to <a href="#manual-tasks">manual tasks</a> Cirrus CI can pause execution of tasks until a corresponding PR gets labeled.
This can be particular useful when you'd like to do an initial review before running all unit and integration
tests on every <a href="../supported-computing-services/">supported platform</a>. Simply use <code>required_pr_labels</code> field to specify
a list of labels a PR requires to have in order to trigger a task. Here is a simple example of <code>.cirrus.yml</code> config
that automatically runs a linting tool but requires <code>initial-review</code> label being presented in order to run tests:</p>
<div class="codehilite"><pre><span></span><span class="nt">lint_task</span><span class="p">:</span>
  <span class="c1"># ...</span>

<span class="nt">test_task</span><span class="p">:</span>
  <span class="nt">required_pr_labels</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">initial-review</span>
  <span class="c1"># ...</span>
</pre></div>

<p><strong>Note:</strong> <code>required_pr_labels</code> has no affect on tasks created for non-PR builds.</p>
<p>You can also require multiple labels to continue executing the task for even more flexibility:</p>
<div class="codehilite"><pre><span></span><span class="nt">deploy_task</span><span class="p">:</span>
  <span class="nt">required_pr_labels</span><span class="p">:</span> 
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">initial-review</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ready-for-staging</span>
  <span class="nt">depends_on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">build</span>
  <span class="c1"># ...</span>
</pre></div>

<p>In the example above both <code>initial-review</code> and <code>ready-for-staging</code> labels should be presented on a PR in order to perform
a deployment via <code>deploy</code> task.</p>
<h2 id="http-cache">HTTP Cache<a class="headerlink" href="#http-cache" title="Permanent link">&para;</a></h2>
<p>For the most cases regular caching mechanism where Cirrus CI caches a folder is more than enough. But modern build systems
like <a href="https://gradle.org/">Gradle</a>, <a href="https://bazel.build/">Bazel</a> and <a href="https://www.pantsbuild.org/">Pants</a> can take
advantage of remote caching. Remote caching is when a build system uploads and downloads intermediate results of a build
execution while the build itself is still executing.</p>
<p>Cirrus CI agent starts a local caching server and exposes it via <code>CIRRUS_HTTP_CACHE_HOST</code> environments variable. Caching server
supports <code>GET</code>, <code>POST</code> and <code>HEAD</code> requests to upload, download and check presence of artifacts.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>If port <code>12321</code> is available <code>CIRRUS_HTTP_CACHE_HOST</code> will be equal to <code>localhost:12321</code>.</p>
</div>
<p>For example running the following command:</p>
<div class="codehilite"><pre><span></span>curl -s -X POST --data-binary @myfolder.tar.gz http://<span class="nv">$CIRRUS_HTTP_CACHE_HOST</span>/mykey
</pre></div>

<p>... has the same effect as a <a href="#cache-instruction">caching instruction</a> of <code>myfolder</code> folder where <code>sha1sum</code> of all the
<code>myfolder</code> contents is equal to <code>mykey</code>:</p>
<div class="codehilite"><pre><span></span><span class="nt">myfolder_cache</span><span class="p">:</span>
  <span class="nt">folder</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">myfolder</span>
</pre></div>

<div class="admonition info">
<p class="admonition-title">Info</p>
<p>To see how HTTP Cache can be used with Gradle's Build Cache please check <a href="../../examples/#build-cache">this example</a>.</p>
</div>
<h2 id="additional-containers">Additional Containers<a class="headerlink" href="#additional-containers" title="Permanent link">&para;</a></h2>
<p>Sometimes one container is not enough to run a CI build. For example, your application might use a MySQL database
as a storage. In this case you most likely want a MySQL instance running for your tests.</p>
<p>One option here is to pre-install MySQL and use a <a href="#background-script-instruction"><code>background_script</code></a> to start it. This
approach has some inconveniences like the need to pre-install MySQL by building a custom Docker container.</p>
<p>For such use cases Cirrus CI allows to run additional containers in parallel with the main container that executes a task.
Each additional container is defined under <code>additional_containers</code> keyword in <code>.cirrus.yml</code>. Each additional container
should have a unique <code>name</code> and specify at least Docker <code>image</code> and <code>port</code> that this container exposes.</p>
<p>In the example below we use an <a href="https://hub.docker.com/_/mysql/">official MySQL Docker image</a> that exposes
the standard MySQL port (3306). Tests will be able to access MySQL instance via <code>localhost:3306</code>.</p>
<div class="codehilite"><pre><span></span><span class="nt">container</span><span class="p">:</span>
  <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">golang:1.9.4</span>
  <span class="nt">additional_containers</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysql</span>
      <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysql:8</span>
      <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3306</span>
      <span class="nt">cpu</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1.0</span>
      <span class="nt">memory</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">512Mi</span>
      <span class="nt">env</span><span class="p">:</span>
        <span class="nt">MYSQL_ROOT_PASSWORD</span><span class="p">:</span> <span class="s">&quot;&quot;</span>
</pre></div>

<p>Additional container can be very handy in many scenarios. Please check <a href="../../examples/">Cirrus CI catalog of examples</a> for more details.</p>
<div class="admonition info">
<p class="admonition-title">Default Resources</p>
<p>By default, each additional container will get <code>0.5</code> CPU and <code>512Mi</code> of memory. These values can be configured as usual
via <code>cpu</code> and <code>memory</code> fields.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Port Mapping</p>
<p>It's also possible to map ports of additional containers by using <code>&lt;HOST_PORT&gt;:&lt;CONTAINER_PORT&gt;</code> format for the <code>port</code> field.
For example, <code>port: 80:8080</code> will map port <code>8080</code> of the container to be available on local port <code>80</code> within a task.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>Note</strong> that <code>additional_containers</code> can be used only with <a href="../supported-computing-services/#community-cluster">Community Cluster</a>
or <a href="../supported-computing-services/#kubernetes-engine">Google's Kubernetes Engine</a>.</p>
</div>
<h2 id="embedded-badges">Embedded Badges<a class="headerlink" href="#embedded-badges" title="Permanent link">&para;</a></h2>
<p>Cirrus CI provides a way to embed a badge that can represent status of your builds into a ReadMe file or a website.</p>
<p>For example, this is a badge for <code>cirruslabs/cirrus-ci-web</code> repository that contains Cirrus CI's front end: <a href="https://github.com/cirruslabs/cirrus-ci-web"><img alt="Passing build badge example" src="https://api.cirrus-ci.com/github/cirruslabs/cirrus-ci-web.svg" /></a></p>
<p>In order to embed such a check into your ReadMe file or your website, simply use a URL to a badge that looks like this:</p>
<div class="codehilite"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">https://api.cirrus-ci.com/github/&lt;USER OR ORGANIZATION&gt;/&lt;REPOSITORY&gt;.svg</span>
</pre></div>

<p>If you want a badge for a particular branch, simply use <code>?branch=&lt;BRANCH NAME&gt;</code> query parameter (at the end of the URL) like this:</p>
<div class="codehilite"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">https://api.cirrus-ci.com/github/&lt;USER OR ORGANIZATION&gt;/&lt;REPOSITORY&gt;.svg?branch=&lt;BRANCH NAME&gt;</span>
</pre></div>

<p>By default, Cirrus picks the latest build in a final state for the repository or a particular branch if <code>branch</code> parameter is specified. It's also possible to explicitly set a concrete build to use with <code>?buildId=&lt;BUILD ID&gt;</code> query parameter.</p>
<p>If you want a badge for a particular task within the latest finished build, simply use <code>?task=&lt;TASK NAME&gt;</code> query parameter (at the end of the URL) like this:</p>
<div class="codehilite"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">https://api.cirrus-ci.com/github/&lt;USER OR ORGANIZATION&gt;/&lt;REPOSITORY&gt;.svg?task=tests</span>
</pre></div>

<p>You can even pick a specific script instruction within the task with an additional <code>script=&lt;SCRIPT NAME&gt;</code> parameter:</p>
<div class="codehilite"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">https://api.cirrus-ci.com/github/&lt;USER OR ORGANIZATION&gt;/&lt;REPOSITORY&gt;.svg?task=build&amp;script=lint</span>
</pre></div>

<h3 id="badges-in-markdown">Badges in Markdown<a class="headerlink" href="#badges-in-markdown" title="Permanent link">&para;</a></h3>
<p>Here is how Cirrus CI's badge can be embeded in a Markdown file:</p>
<div class="codehilite"><pre><span></span>[![Build Status](https://api.cirrus-ci.com/github/&lt;USER OR ORGANIZATION&gt;/&lt;REPOSITORY&gt;.svg)](https://cirrus-ci.com/github/&lt;USER OR ORGANIZATION&gt;/&lt;REPOSITORY&gt;)
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-nav">
    <nav class="md-footer-nav__inner md-grid">
      
      <a href="/guide/quick-start/" title="Quick Start" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
        <div class="md-flex__cell md-flex__cell--shrink">
          <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
        </div>
        <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Quick Start
              </span>
        </div>
      </a>
      
      
      <a href="/guide/tips-and-tricks/" title="Configuration Tips and Tricks" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
        <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Configuration Tips and Tricks
              </span>
        </div>
        <div class="md-flex__cell md-flex__cell--shrink">
          <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
        </div>
      </a>
      
    </nav>
  </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        <div class="md-footer-copyright__highlight">
          © Cirrus Labs 2017-present
        </div>
        
      </div>
      
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/cirruslabs" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/cirrus_labs" class="md-footer-social__link fa fa-twitter"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.a8b5e56f.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>